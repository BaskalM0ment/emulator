<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Multi-System Drop & Play — Emulator (offline NES)</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{display:flex;flex-direction:column;align-items:center;gap:16px;padding:24px;background:#0b1220;color:#dbe7ff}
    .drop{width:640px;max-width:95vw;height:160px;border:3px dashed rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;border-radius:12px;background:linear-gradient(180deg,#071022, #0d1b2d);cursor:pointer;text-align:center}
    .drop.drag{border-color:rgba(124, 211, 255, .6);box-shadow:0 8px 30px rgba(0,0,0,.6)}
    canvas{image-rendering:pixelated;border-radius:6px;box-shadow:0 8px 40px rgba(2,6,23,.7)}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center}
    button{background:#0f2336;border:1px solid rgba(255,255,255,0.1);color:#cfe9ff;padding:8px 12px;border-radius:8px;cursor:pointer}
    small{opacity:0.7}
    a{color:#9fe7ff}
  </style>
</head>
<body>
  <h1 style="margin:0;font-size:20px">Offline NES Emulator</h1>
  <div id="drop" class="drop">
    <div>
      <div style="font-weight:700">Drop a NES ROM file here</div>
      <div style="margin-top:6px"><small>or click to choose a file</small></div>
    </div>
  </div>

  <canvas id="screen" width="256" height="240" style="width:512px;height:480px;display:none"></canvas>

  <div class="controls">
    <button id="resetBtn" disabled>Reset</button>
    <button id="pauseBtn" disabled>Pause</button>
    <button id="saveBtn" disabled>Save State</button>
    <button id="loadBtn" disabled>Load State</button>
    <button id="exportStateBtn" disabled>Export State</button>
    <button id="importStateBtn">Import State</button>
    <button id="saveRomBtn" disabled>Save ROM</button>
    <label style="display:flex;align-items:center;gap:8px"><input id="scale" type="range" min="1" max="4" value="2"> <small>scale</small></label>
  </div>

  <div><small>Controls: Arrow keys = D-pad, Z = A, X = B, Enter = Start, Shift = Select</small></div>

  <!-- hidden file inputs -->
  <input id="fileInput" type="file" accept=".nes" style="display:none">
  <input id="importStateInput" type="file" accept=".json" style="display:none">

  <!-- ✅ Embedded jsnes core -->
  <script>
  /* --- BEGIN jsnes.min.js --- */
  /* The entire jsnes.min.js code goes here.
     Download from https://unpkg.com/jsnes@0.7.0/dist/jsnes.min.js
     Copy-paste everything into this block */
  /* --- END jsnes.min.js --- */
  </script>

  <script>
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('fileInput');
    const importStateInput = document.getElementById('importStateInput');
    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');
    const resetBtn = document.getElementById('resetBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const saveBtn = document.getElementById('saveBtn');
    const loadBtn = document.getElementById('loadBtn');
    const exportStateBtn = document.getElementById('exportStateBtn');
    const saveRomBtn = document.getElementById('saveRomBtn');
    const scale = document.getElementById('scale');

    let nes = null;
    let imageData = ctx.createImageData(256, 240);
    let running = false;
    let currentROM = null;

    function arrayBufferToBinaryString(buffer) {
      const bytes = new Uint8Array(buffer);
      let binary = '';
      const chunk = 0x8000;
      for (let i = 0; i < bytes.length; i += chunk) {
        binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
      }
      return binary;
    }

    function startNES(romBuffer) {
      nes = new jsnes.NES({
        onFrame: function(frameBuffer) {
          const data = imageData.data;
          let p = 0;
          for (let i = 0; i < frameBuffer.length; i++) {
            const c = frameBuffer[i] | 0;
            data[p++] = (c >> 16) & 0xff;
            data[p++] = (c >> 8) & 0xff;
            data[p++] = c & 0xff;
            data[p++] = 0xff;
          }
          ctx.putImageData(imageData, 0, 0);
        }
      });

      const binary = arrayBufferToBinaryString(romBuffer);
      nes.loadROM(binary);
      currentROM = romBuffer;
      canvas.style.display = 'block';
      resetBtn.disabled = false;
      pauseBtn.disabled = false;
      saveBtn.disabled = false;
      loadBtn.disabled = false;
      exportStateBtn.disabled = false;
      saveRomBtn.disabled = false;
      running = true;

      function frame() {
        if (running) nes.frame();
        requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    // File handling
    drop.addEventListener('click', () => fileInput.click());
    ['dragenter','dragover'].forEach(e => drop.addEventListener(e, ev => {ev.preventDefault(); drop.classList.add('drag');}));
    ['dragleave','drop'].forEach(e => drop.addEventListener(e, ev => {ev.preventDefault(); drop.classList.remove('drag');}));

    drop.addEventListener('drop', ev => {
      const f = ev.dataTransfer.files[0];
      if (!f) return;
      handleFile(f);
    });

    fileInput.addEventListener('change', ev => {
      const f = ev.target.files[0];
      if (!f) return;
      handleFile(f);
    });

    function handleFile(file) {
      if (!file.name.toLowerCase().endsWith('.nes')) {
        alert('Only .nes files supported here');
        return;
      }
      const reader = new FileReader();
      reader.onload = () => startNES(reader.result);
      reader.readAsArrayBuffer(file);
    }

    // Controls
    const KEYMAP = {37:'LEFT',38:'UP',39:'RIGHT',40:'DOWN',90:'A',88:'B',13:'START',16:'SELECT'};
    document.addEventListener('keydown', e => handleKey(e, true));
    document.addEventListener('keyup', e => handleKey(e, false));

    function handleKey(e, down) {
      if (!nes) return;
      const key = KEYMAP[e.keyCode];
      if (!key) return;
      const map = {'A':0,'B':1,'SELECT':2,'START':3,'UP':4,'DOWN':5,'LEFT':6,'RIGHT':7};
      const btn = map[key];
      if (btn === undefined) return;
      if (down) nes.buttonDown(1, btn); else nes.buttonUp(1, btn);
      e.preventDefault();
    }

    resetBtn.addEventListener('click', () => { if (nes) nes.reset(); });
    pauseBtn.addEventListener('click', () => { running = !running; pauseBtn.textContent = running ? 'Pause' : 'Resume'; });

    // Save/Load state
    saveBtn.addEventListener('click', () => {
      if (!nes) return;
      localStorage.setItem('saveState', JSON.stringify(nes.toJSON()));
      alert('State saved.');
    });

    loadBtn.addEventListener('click', () => {
      if (!nes) return;
      const state = localStorage.getItem('saveState');
      if (state) nes.fromJSON(JSON.parse(state));
      else alert('No save found.');
    });

    exportStateBtn.addEventListener('click', () => {
      if (!nes) return;
      const blob = new Blob([JSON.stringify(nes.toJSON())], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'state.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('importStateBtn').addEventListener('click', () => importStateInput.click());
    importStateInput.addEventListener('change', ev => {
      const f = ev.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try { nes.fromJSON(JSON.parse(reader.result)); alert('State imported.'); }
        catch(e){alert('Import failed.');}
      };
      reader.readAsText(f);
    });

    saveRomBtn.addEventListener('click', () => {
      if (!currentROM) return;
      const blob = new Blob([currentROM], {type:'application/octet-stream'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'game.nes';
      a.click();
      URL.revokeObjectURL(url);
    });

    scale.addEventListener('input', () => {
      const s = +scale.value;
      canvas.style.width = (256*s) + 'px';
      canvas.style.height = (240*s) + 'px';
    });
    scale.dispatchEvent(new Event('input'));
  </script>
</body>
</html>
